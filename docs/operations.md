# التشغيل والحوكمة

## 1. إعدادات النظام
- واجهة إعدادات للمسؤول تحتوي على أقسام:
  1. الإعدادات العامة (تنسيقات التاريخ، المنطقة الزمنية الافتراضية = آسيا/الرياض).
  2. الصلاحيات (مصفوفة الوصول للمشاهدين، إعدادات دور Trial، تخصيص قدرات الأدوار).
  3. تكامل Google Drive (المجلد الرئيسي للمرفقات، مجلد النسخ الاحتياطية، إعادة المصادقة).
  4. سياسة الاحتفاظ بالسجلات (لكل كيان، لكل مشروع، وأرشفة عالمية).
  5. النسخ الاحتياطي (جدولة، الاحتفاظ، مفتاح التشفير).
  6. الإشعارات (نوع الحدث، القنوات، ساعات الهدوء).
  7. الاستيراد (قوالب، العتبات، القواعد التحذيرية).
  8. التقارير والقوالب (PDF/XLSX).
  9. المساعد الذكي (مزود API، تمكين للأدوار، إعداد الخصوصية).

## 2. RBAC وسياسات RLS
- **Admin**: تجاوز كامل، يُسمح بالحذف الدائم، الوصول لكل الجداول.
- **Projects Director**: سياسات تتيح كل المشاريع لكن تمنع تعديل جداول الأدوار والإعدادات.
- **Project Manager**: الوصول للمشاريع المحددة فقط؛ CRUD على المستندات داخلها.
- **Supervisor**: CRUD على MR/RT ضمن مشاريعهم؛ منع الموافقات النهائية.
- **Viewer**: SELECT فقط على الجداول المحددة من قبل المسؤول (قائمة تخزين في `viewer_access_matrix`).
- **Trial**: SELECT مع استبدال الحقول المالية عبر View مخصص أو `SECURITY DEFINER` function تُرجع قيم مقنعة.

## 3. إدارة الإشعارات
- أحداث يتم التقاطها عبر Triggers Postgres تكتب في جدول `notification_events`.
- Edge Function تستهلك الأحداث وتدفع إشعار فوري عبر Supabase Realtime.
- البريد الإلكتروني يستخدم خدمة مجانية (Resend Free Tier). إذا تجاوزت الحدود يتم تعليق البريد والاكتفاء بالإشعارات داخل التطبيق.
- إعدادات المستخدم تحدد القنوات وساعات الصمت؛ أي حدث خلال ساعات الصمت يتم جدولة إرساله لاحقًا.

## 4. النسخ الاحتياطي والاستعادة
- النسخ اليومي يخلق ملفات مشفرة في Drive. لاستعادة، يقوم Admin بتنزيل الملف ويدخله في أداة استعادة داخل لوحة الإدارة (إرشادات).
- النسخة اليدوية المحلية يتم تحميلها من واجهة المستخدم، وتشمل بيانات مصفاة حسب الدور.
- التحقق من السلامة (`checksum`) قبل قبول النسخة.
- سجلات النسخ مرتبطة بـ Audit Log.

## 5. إدارة المرفقات
- تخزين بيانات OAuth مشفر.
- التحكم بالإصدارات عبر `version` و`is_latest`.
- عملية الحذف للمستخدمين غير المسؤولين = Soft Delete، تُحدث Drive عبر تحريك الملف إلى مجلد سلة خاص مع وضع علامة `trashed` في البيانات الوصفية.
- المسؤول يستطيع الحذف الدائم من Drive ومن السجل.

## 6. دليل المستخدم والمساعدة
- دليل المستخدم مخزن في جدول `user_manual_sections` (عنوان، محتوى Markdown عربي، كلمات مفتاحية).
- واجهة بحث تعتمد على `tsvector` عربي في Postgres.
- كل رسالة خطأ تتضمن رابطًا إلى القسم المناسب + شرح عربي واضح.

## 7. السجلات والتشخيص
- سجل أخطاء داخلي `error_logs` متاح للمسؤول فقط: تخزن الاستثناءات، التوقيت، الطلب، stacktrace.
- تكامل مع Logflare/Sentry (خطة مجانية) لالتقاط الأخطاء الأمامية والخلفية.

## 8. التدرج المستقبلي
- إمكانية ترقية Supabase إلى خطة مدفوعة أو استخدام Neon + Cloudflare Workers إذا زادت الأحمال.
- دعم محاسبة متقدم، تكامل ERP، مستويات موافقات متعددة، دعم تطبيق جوال عبر React Native باستخدام نفس API.

