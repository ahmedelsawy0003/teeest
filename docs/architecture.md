# مخطط معماري لمنصة سواعدنا

## 1. نظرة عامة
- **النموذج التشغيلي**: تطبيق ويب أحادي الصفحة (SPA) باستخدام **Next.js 14** (App Router) مستضاف على **Vercel** بخطة مجانية.
- **الخلفية**: خدمات بلا خادم عبر **Supabase** (قاعدة بيانات Postgres مُدارة + مصادقة + التخزين المؤقت) مع وظائف بلا خادم (Edge Functions) للمنطق المخصص.
- **التكلفة**: جميع المكونات ضمن خطط مجانية أو منخفضة التكلفة لمدة عامين (Vercel Hobby، Supabase Free، Google Drive API، Resend/Elastic Email المجانية للرسائل الأساسية).
- **اللغة**: واجهة عربية بالكامل (RTL) باستخدام TailwindCSS وتخصيصات تصميم عربية.

## 2. المكونات الرئيسية
| المكون | التقنية | الدور |
| --- | --- | --- |
| واجهة المستخدم | Next.js + React + Tailwind (RTL) | إدارة تجربة المستخدم، التوجيه، التخطيط، لوحة القيادة، المساعد الذكي |
| إدارة الحالة | Zustand + React Query | مزامنة البيانات مع Supabase وتخزين المؤقت|
| المصادقة و RBAC | Supabase Auth (Email/OTP) + سياسات Postgres Row Level Security | تسجيل الدخول، أدوار، سياسات على مستوى الصف لمشاريع محددة |
| واجهة برمجة التطبيقات | Supabase PostgREST + Edge Functions | CRUD على الجداول مع قواعد RLS، وظائف معقدة (الموافقات، الاستيراد/التصدير) |
| الاستيراد/التصدير | Edge Functions + مكتبات node (xlsx, pdfkit, puppeteer-lite) | معالجة ملفات XLSX، إنشاء PDF، تخزين النتائج المؤقتة في التخزين المؤقت |
| النسخ الاحتياطي | Edge Cron + Google Drive API | نسخ احتياطي يومي مشفر، رفع إلى Drive |
| الإشعارات | Supabase Realtime + Edge Functions + Resend (Email) | إشعارات داخلية، رسائل بريد عند توفر طبقة مجانية |
| المساعد الذكي | واجهة مع نموذج متوافق مع OpenAI (مثلاً Together.ai أو Azure OpenAI المجاني) | إجابات سياقية، شرح الأخطاء |
| التخزين المؤقت | Supabase Storage (لملفات التصدير المؤقتة) + روابط Google Drive للمرفقات | يدير الروابط وحالات التخزين المؤقت |
| المراقبة | Logflare (مدمج في Supabase) + سجل أخطاء Admin Only | مراقبة تشغيلية |

## 3. تدفق البيانات الرئيسي
1. المستخدم يسجل دخول عبر Supabase Auth (OTP أو سحابة البريد الإلكتروني).
2. الواجهة تسحب ملف تعريف المستخدم والأدوار من جدول `user_profiles`، وتفعّل السياسات حسب المشروع.
3. الطلبات تمر عبر PostgREST مع سياسات RLS تمنع الوصول غير المصرح.
4. العمليات المعقدة (الاستيراد، إنشاء PDF، النسخ الاحتياطي) تستخدم وظائف Edge Functions باستخدام مفاتيح الخدمة، وتكتب في جداول التدقيق والإشعارات.
5. المرفقات ترفع مباشرةً إلى Google Drive عبر خدمة مخصّصة (Edge Function يستخدم OAuth Refresh Token مخزن في جدول مشفر).
6. النسخ الاحتياطي اليومي يُشغَّل بواسطة Supabase Edge Cron ويُحمّل نسخة مشفرة من قاعدة البيانات إلى Drive.

## 4. التصميم المنطقي للواجهات
- **التنقل الرئيسي**: شريط جانبي يمين، يضم الأقسام المطلوبة بالعربية.
- **لوحة القيادة**: عناصر KPI، مخططات (Chart.js)، تنبيهات، تدفق نشاط (AuditLog).
- **صفحات المشاريع**: بطاقات المشاريع، عرض الميزانية، تحذيرات 90%.
- **BOQ**: جدول قابل للبحث مع استيراد XLSX، تصفية، تنفيذ.
- **الطلبات**: معالج Material Request/Return، إجراءات موافقة.
- **المشتريات والمدفوعات**: جداول مع حالة الموافقة، خطوط الزمن.
- **المرفقات**: عرض شبكي، أوسمة، إصدار.
- **البحث المتقدم**: مُرشحات متعددة، حفظ ومشاركة المشاهد.
- **الإعدادات**: لوحة شاملة للإدارة، تكوين Google Drive، النسخ الاحتياطي، التراخيص.
- **المساعدة والمساعد**: دليل قابل للبحث، شات مساعد.

## 5. التكامل مع Google Drive
- استخدام OAuth 2.0 لتخويل الحساب الإداري مرة واحدة (Admin Panel يطلب التفويض).
- تخزين Refresh Token مشفر باستخدام **Supabase Vault** (أو تشفير AES داخل Edge Function).
- المرفقات تُرفع عبر Edge Function وتُخزن البيانات الوصفية في جدول `attachment_links` مع معرف Drive.
- النسخ الاحتياطية اليومية: وظيفة Edge تقوم بتصدير قاعدة البيانات (pg_dump)، تشفير الملف بـ AES-256 باستخدام مفتاح يتم تدويره ربع سنويًا، ثم رفع الملف إلى Drive مع الاحتفاظ بـ 14 نسخة.

## 6. الأمان والامتثال
- تفعيل RLS لجميع الجداول مع سياسات حسب الدور والمشروع.
- سجلات التدقيق في جدول مستقل مع before/after JSON.
- عمليات الحذف: أعمدة `deleted_at`, `deleted_by` في جميع الجداول (باستثناء المشرف).
- إعدادات الاستبقاء (Retention) مخزنة في جدول وتُطبق عبر وظائف مجدولة تنظف السجلات المؤرشفة.
- حماية سرية المفاتيح عبر Supabase Vault.
- تشفير الاتصالات (HTTPS افتراضي عبر Vercel/Supabase).

## 7. القابلية للتوسع
- Supabase Postgres مع خطة مدفوعة لاحقًا عند الحاجة (20 مشروعاً و15 مستخدمًا يمكن أن تعمل على خطة مجانية).
- Edge Functions متدرجة تلقائيًا، ويمكن نقل الاستيراد الثقيل إلى وظائف Cloud Run عند الحاجة.
- استخدام Web Workers في المتصفح لمعالجة XLSX قبل الإرسال لتقليل زمن الوظائف.

## 8. خارطة الطريق التقنية (3 مراحل)
1. **MVP (4 أسابيع)**: مصادقة، إدارة مشاريع، BOQ، طلبات MR/RT، موافقات، إشعارات داخلية، دليل المستخدم.
2. **المرحلة 2 (6 أسابيع)**: PO/PY، الاستيراد/التصدير الكامل، النسخ الاحتياطي، Google Drive، تقارير PDF.
3. **المرحلة 3 (4 أسابيع)**: المساعد الذكي، تكامل البريد الإلكتروني، تحسينات البحث المتقدم، النسخ الاحتياطية اليدوية والتقارير المالية المتقدمة.

## 9. المعايير التقنية الإضافية
- الاختبارات: Playwright لواجهة المستخدم، Vitest للوحدات، Supabase Test Harness لقاعدة البيانات.
- CI/CD: GitHub Actions (خط مجاني) للبناء، lint، الاختبارات، ونشر Vercel.
- التوثيق: Storybook لعرض المكونات، دليل مستخدم مُخزن في جدول CMS (Supabase) يمكن تحديثه من الواجهة.

