# تدفقات العمل الرئيسية

## 1. إدارة المستخدمين والصلاحيات
1. يسجل المستخدم الجديد → دور Trial تلقائيًا.
2. Admin يراجع المستخدم من شاشة "إدارة المستخدمين" ويحدد الدور + المشاريع.
3. تحديث الدور يطلق سجل تدقيق وإشعار للمستخدم.
4. كل السياسات تعتمد على `user_roles_projects` و `role_permissions` لضمان الوصول الحبيبي.

## 2. دورة الموافقات
| الوثيقة | منشئ | موافق | صلاحية التعديل/الإلغاء |
| --- | --- | --- | --- |
| Material Request | Supervisor/Project Manager | Project Manager | المنشئ حتى قرار الموافقة |
| Material Return | Supervisor/Project Manager | Project Manager | المنشئ حتى قرار الموافقة |
| Purchase Order | Project Manager | Projects Director | المنشئ حتى قرار الموافقة |
| Payment Order | Project Manager/محاسب | Projects Director (أو Accountant لاحقًا) | المنشئ حتى قرار الموافقة |

- الحالات: `draft` → `submitted` → `under_review` → `approved/rejected`.
- إشعارات فورية عند التقديم والقرار.
- سجل تدقيق قبل/بعد لكل تغيير حالة.

## 3. استيراد ملفات Excel
1. المستخدم يفتح معالج الاستيراد → اختيار الكيان (BOQ، مورد، إلخ).
2. الخطوات الخمس بالعربية مع إرشادات تفصيلية.
3. التعرف التلقائي على الأعمدة باستخدام خوارزمية تشابه (threshold 0.82).
4. تمكين التعديل اليدوي وحفظ التعيينات كقوالب (محلي للمشروع أو عالمي للإدارة).
5. التحقق من السجلات (قواعد صلبة/تحذيرية) قبل التنفيذ.
6. عرض المعاينة مع ألوان للحالة (أخضر/أصفر/أحمر) وإمكانية تنزيل تقرير الأخطاء.
7. عند النجاح يتم إنشاء سجل `import_job` وسجل تدقيق.

## 4. تصدير PDF
- مستندات MR/RT/PO/PY وقوالب التقارير تستخدم قالب RTL عبر `@react-pdf/renderer` أو `Puppeteer` لإنتاج PDF.
- الحقول المالية تُخفى أو تستبدل للمستخدمين `trial` عبر فلتر داخل الوظيفة.
- تضمين توقيعات رقمية (صور) وإمكانية إضافة ختم الشركة.

## 5. النسخ الاحتياطي والمرفقات
- **نسخ يومي تلقائي**: وظيفة Edge Cron عند 02:00 بتوقيت الرياض تقوم بـ:
  1. تشغيل `pg_dump` على قاعدة البيانات.
  2. ضغط الملف `gzip`، ثم تشفير AES-256 بمفتاح مخزن في Vault.
  3. رفع الملف إلى مجلد Google Drive محدد في الإعدادات، مع تسمية `backup-YYYY-MM-DD.sql.gz.enc`.
  4. تحديث جدول `backup_jobs` بالحالة والنتيجة.
  5. إرسال إشعار نجاح/فشل للمسؤولين.
- **نسخ يدوي محلي**: زر داخل الواجهة يولد ملفًا ZIP يحتوي على بيانات مسموح بها حسب الدور، ويُسجل في `backup_jobs`.
- **المرفقات**: تحميل الملفات من الواجهة → رفع إلى Edge Function → إرسال إلى Google Drive → تخزين البيانات الوصفية والإصدارات.

## 6. المساعد الذكي
1. Admin يفعّل المساعد ويدخل مفتاح API.
2. المستخدم المصرح له يفتح نافذة المحادثة، حيث يتم تمرير سياق الصفحة والدور.
3. يتم إنشاء مطالبة باللغتين العربية والإنجليزية (المحتوى الرئيسي عربي) تتضمن الأخطاء الأخيرة، نص دليل المستخدم، وأي تحذيرات.
4. Edge Function يتصل بموفر الـ LLM، مع الالتزام بالحد اليومي للرموز والطلبات.
5. الردود تُخزن في `ai_messages` مع تدقيق، ويتم إخفاء البيانات الحساسة.

## 7. البحث المتقدم والمشاهد المحفوظة
- واجهة البحث تسمح بتحديد المرشحات المركبة.
- عند الحفظ، يتم إنشاء سجل `saved_views` مع JSON لهيكل الاستعلام.
- المشاركة تتم عبر إنشاء سجلات مشاركة مع مستخدمين أو أدوار محددة.
- المشاهد تحترم RBAC عبر تطبيق نفس سياسات RLS عند التنفيذ.

## 8. سجل التدقيق والأرشفة
- كل عملية CRUD تفعّل Trigger يقوم بمقارنة القيم قبل/بعد وتسجيلها.
- واجهة "سجل النشاط" تظهر الأحداث مع إمكانية الفلترة حسب الكيان والمستخدم.
- الأرشفة تعتمد على إعدادات الاحتفاظ، وتتم عبر وظيفة مجدولة تنقل السجلات إلى جداول `_archive` أو تخزنها في JSON في التخزين.

